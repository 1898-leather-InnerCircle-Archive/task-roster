<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>1898 Leather - Task Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <style>
      .task-row { border-bottom: 1px solid #e5e7eb; transition: all 0.2s; }
      .task-row:hover { background-color: #f9fafb; }
      .header-row { background-color: #f3f4f6; font-weight: 600; }
      textarea:focus { outline: none; background: white; box-shadow: 0 0 0 2px #bfdbfe; }
      #loginOverlay { backdrop-filter: blur(8px); }
    </style>
  </head>

  <body class="bg-gray-50 min-h-screen relative">
    
    <div id="loginOverlay" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 transition-opacity duration-500">
      <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full mx-4 border-t-8 border-blue-600">
        <h2 class="text-2xl font-bold text-gray-900 mb-2 text-center">Security Access</h2>
        <p class="text-gray-500 text-center mb-6 text-sm">Please enter your GitHub Personal Access Token to manage 1898 Leather tasks.</p>
        <input type="password" id="tokenInput" placeholder="ghp_xxxxxxxxxxxx" class="w-full border border-gray-300 rounded-lg px-4 py-3 mb-4 focus:ring-2 focus:ring-blue-500 outline-none transition-all" />
        <button onclick="saveTokenAndLoad()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 shadow-lg transition-colors">
          Unlock System
        </button>
      </div>
    </div>

    <div id="mainContent" class="container mx-auto px-4 py-8 max-w-7xl opacity-20 transition-opacity duration-1000">
      <div class="bg-white rounded-lg shadow-lg p-6 mb-8 border-b-4 border-blue-600 flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">1898 Leather</h1>
          <h2 class="text-xl text-gray-600 italic">Task Management System</h2>
        </div>
        <div class="flex items-center gap-4">
          <button onclick="addNewTask()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-blue-700 shadow transition-all">+ Add New Task</button>
          <span id="syncStatus" class="text-xs font-bold uppercase px-3 py-1 rounded-full bg-gray-100 text-gray-500 italic border border-gray-200">Waiting...</span>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6 mb-8 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-xs uppercase tracking-widest text-gray-500 font-bold">Search Tasks</label>
          <input id="searchInput" type="search" placeholder="Filter by name or notes..." class="mt-2 w-full rounded border border-gray-200 px-4 py-2 text-sm focus:ring-2 focus:ring-blue-200 outline-none transition-all" />
        </div>
        <div>
          <label class="block text-xs uppercase tracking-widest text-gray-500 font-bold">Status Filter</label>
          <select id="statusFilter" class="mt-2 w-full rounded border border-gray-200 px-4 py-2 text-sm outline-none cursor-pointer">
            <option value="all">All Status</option>
            <option value="in-progress">In Progress</option>
            <option value="pending">Pending</option>
            <option value="planning">Planning</option>
            <option value="completed">Completed</option>
          </select>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="header-row px-6 py-3 grid grid-cols-1 md:grid-cols-6 gap-4 text-xs uppercase tracking-wider text-gray-600 border-b">
          <div>ID</div>
          <div>Task Name</div>
          <div>Notes</div>
          <div>Status</div>
          <div>Updated</div>
          <div>Priority</div>
        </div>
        <div id="taskRows" class="divide-y divide-gray-200 italic text-gray-400"></div>
      </div>
    </div>

    <script>
      const GITHUB_CONFIG = {
          owner: '1898-leather-InnerCircle-Archive',
          repo: 'task-roster', // Verifica si el repo se llama solo 'task-roster' o '1898-leather-InnerCircle-Archive/task-roster'
          path: 'tasks.json'
      };

      let tasks = [];
      let currentToken = sessionStorage.getItem('gh_token');

      // ====== MANEJO DE ACCESO ======
      function saveTokenAndLoad() {
          const input = document.getElementById('tokenInput');
          if (input.value.trim().length > 10) {
              sessionStorage.setItem('gh_token', input.value.trim());
              currentToken = input.value.trim();
              unlockApp();
          } else {
              alert("Please enter a valid token.");
          }
      }

      function unlockApp() {
          document.getElementById('loginOverlay').classList.add('hidden');
          document.getElementById('mainContent').classList.remove('opacity-20');
          loadTasks();
      }

      // ====== OPERACIONES DE API ======
      async function loadTasks() {
          updateSyncStatus('Syncing...', 'yellow');
          try {
              const resp = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}?t=${new Date().getTime()}`, {
                  headers: { 'Authorization': `token ${currentToken}` }
              });
              
              if (!resp.ok) throw new Error('Token inválido o error de repo');
              
              const data = await resp.json();
              tasks = JSON.parse(atob(data.content));
              render();
              updateSyncStatus('Synced', 'green');
          } catch (e) {
              console.error(e);
              updateSyncStatus('Auth Error', 'red');
              sessionStorage.removeItem('gh_token');
              alert("Failed to access GitHub. Please check your token and repository name.");
              location.reload();
          }
      }

      async function updateGitHub(taskId, updatedFields) {
          updateSyncStatus('Saving...', 'yellow');
          try {
              const fileResp = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`, {
                  headers: { 'Authorization': `token ${currentToken}` }
              });
              const fileData = await fileResp.json();
              
              const index = tasks.findIndex(t => t.id === taskId);
              tasks[index] = { 
                ...tasks[index], 
                ...updatedFields, 
                lastTouched: new Date().toISOString().split('T')[0] 
              };

              const updateResp = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`, {
                  method: 'PUT',
                  headers: {
                      'Authorization': `token ${currentToken}`,
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                      message: `Task Update: ${taskId}`,
                      content: btoa(unescape(encodeURIComponent(JSON.stringify(tasks, null, 2)))),
                      sha: fileData.sha
                  })
              });

              if (updateResp.ok) {
                  updateSyncStatus('Saved', 'green');
                  render();
              }
          } catch (e) {
              updateSyncStatus('Error', 'red');
              alert("Connection lost. Check your internet or token.");
          }
      }

      async function addNewTask() {
          const name = prompt("Enter new task name:");
          if (!name) return;
          
          const newTask = {
              id: `TASK-${Math.floor(Math.random() * 900) + 100}`,
              name: name,
              notes: "Write details here...",
              status: "pending",
              lastTouched: new Date().toISOString().split('T')[0],
              priority: "Medium"
          };
          
          tasks.unshift(newTask);
          updateSyncStatus('Adding...', 'yellow');
          
          // Reutilizamos la lógica de PUT para subir todo el array actualizado
          const fileResp = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`, {
              headers: { 'Authorization': `token ${currentToken}` }
          });
          const fileData = await fileResp.json();
          
          await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`, {
              method: 'PUT',
              headers: { 'Authorization': `token ${currentToken}`, 'Content-Type': 'application/json' },
              body: JSON.stringify({
                  message: `New Task: ${newTask.id}`,
                  content: btoa(unescape(encodeURIComponent(JSON.stringify(tasks, null, 2)))),
                  sha: fileData.sha
              })
          });
          
          updateSyncStatus('Saved', 'green');
          render();
      }

      // ====== UI RENDER ======
      function updateSyncStatus(text, color) {
          const el = document.getElementById('syncStatus');
          el.textContent = text;
          el.className = `text-xs font-bold uppercase px-3 py-1 rounded-full bg-${color}-100 text-${color}-700 border border-${color}-300 transition-all`;
      }

      function render() {
          const q = (document.getElementById("searchInput").value || "").toLowerCase();
          const st = document.getElementById("statusFilter").value;

          const filtered = tasks.filter(t => {
              const textMatch = (t.name + t.notes).toLowerCase().includes(q);
              const statusMatch = st === "all" || t.status === st;
              return textMatch && statusMatch;
          });

          const statusStyles = {
              "in-progress": "bg-yellow-100 text-yellow-800 border-yellow-300",
              "pending": "bg-blue-100 text-blue-800 border-blue-300",
              "planning": "bg-purple-100 text-purple-800 border-purple-300",
              "completed": "bg-green-100 text-green-800 border-green-300"
          };

          document.getElementById('taskRows').innerHTML = filtered.map(t => `
              <div class="task-row px-6 py-4 grid grid-cols-1 md:grid-cols-6 gap-4 items-center bg-white ${t.priority === 'High' ? 'border-l-4 border-red-500' : 'border-l-4 border-gray-200'}">
                  <div class="font-mono text-xs text-gray-400 font-bold">${t.id}</div>
                  <div class="font-bold text-gray-800 text-sm">${t.name}</div>
                  <textarea onblur="updateGitHub('${t.id}', {notes: this.value})" 
                      class="text-sm text-gray-600 bg-transparent p-1 rounded resize-none border border-transparent hover:border-gray-200 hover:bg-gray-50 h-16 transition-all">${t.notes}</textarea>
                  <select onchange="updateGitHub('${t.id}', {status: this.value})" 
                      class="text-xs font-bold rounded-full px-3 py-1 ${statusStyles[t.status] || 'bg-gray-100'} border outline-none cursor-pointer appearance-none text-center">
                      <option value="in-progress" ${t.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                      <option value="pending" ${t.status === 'pending' ? 'selected' : ''}>Pending</option>
                      <option value="planning" ${t.status === 'planning' ? 'selected' : ''}>Planning</option>
                      <option value="completed" ${t.status === 'completed' ? 'selected' : ''}>Completed</option>
                  </select>
                  <div class="text-xs text-gray-400 italic">${t.lastTouched}</div>
                  <div class="text-xs font-bold ${t.priority === 'High' ? 'text-red-500' : 'text-gray-500'}">${t.priority}</div>
              </div>
          `).join("");
      }

      // Event Listeners
      document.getElementById("searchInput").addEventListener("input", render);
      document.getElementById("statusFilter").addEventListener("change", render);

      // Iniciar
      if (currentToken) {
          unlockApp();
      }
    </script>
  </body>
</html>
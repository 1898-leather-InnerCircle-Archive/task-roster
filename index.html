<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>1898 Leather - Task Management System</title>

    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />

    <!-- ✅ Supabase JS v2 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- ✅ Stop favicon 404 (optional) -->
    <link rel="icon" href="data:," />

    <style>
      .priority-high { border-left: 4px solid #ef4444; }
      .priority-medium { border-left: 4px solid #f59e0b; }
      .priority-low { border-left: 4px solid #10b981; }

      .task-row { border-bottom: 1px solid #e5e7eb; }
      .task-row:hover { background-color: #f9fafb; }
      .header-row { background-color: #f3f4f6; font-weight: 600; }

      .pill {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 700;
        line-height: 1.1;
        white-space: nowrap;
      }

      .pill-inprogress { background: #fef3c7; color: #92400e; }
      .pill-pending { background: #dbeafe; color: #1e40af; }
      .pill-planning { background: #e0e7ff; color: #3730a3; }
      .pill-completed { background: #d1fae5; color: #065f46; }

      .pill-do { background: #fee2e2; color: #991b1b; }
      .pill-schedule { background: #e0f2fe; color: #075985; }
      .pill-delegate { background: #fef9c3; color: #854d0e; }

      .tab-active { background: #111827; color: #fff; }

      .pill-select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        border: 1px solid transparent;
        outline: none;
        cursor: pointer;
        width: 100%;
        text-align: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 800;
        background-image: linear-gradient(45deg, transparent 50%, currentColor 50%),
          linear-gradient(135deg, currentColor 50%, transparent 50%),
          linear-gradient(to right, transparent, transparent);
        background-position: calc(100% - 14px) calc(50% - 2px),
          calc(100% - 9px) calc(50% - 2px), 0 0;
        background-size: 5px 5px, 5px 5px, 100% 100%;
        background-repeat: no-repeat;
        padding-right: 26px;
      }

      .sel-inprogress { background-color: #fef3c7; color: #92400e; }
      .sel-pending { background-color: #dbeafe; color: #1e40af; }
      .sel-planning { background-color: #e0e7ff; color: #3730a3; }
      .sel-completed { background-color: #d1fae5; color: #065f46; }

      .sel-do { background-color: #fee2e2; color: #991b1b; }
      .sel-schedule { background-color: #e0f2fe; color: #075985; }
      .sel-delegate { background-color: #fef9c3; color: #854d0e; }

      .sel-High { background-color: #fee2e2; color: #991b1b; }
      .sel-Medium { background-color: #fef3c7; color: #92400e; }
      .sel-Low { background-color: #d1fae5; color: #065f46; }

      .sort-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 10px;
        cursor: pointer;
        user-select: none;
        transition: background 0.15s, color 0.15s;
      }
      .sort-btn:hover { background: #e5e7eb; color: #111827; }
      .sort-active { background: #111827; color: white; }
      .sort-caret { font-size: 10px; opacity: 0.9; }

      .modal-backdrop { backdrop-filter: blur(8px); }

      /* ✅ Notes wrapping */
      .wrap-anywhere { overflow-wrap: anywhere; word-break: break-word; }

      /* ✅ simple clamp without plugin */
      .clamp-3 {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 3;
        overflow: hidden;
      }

      /* Mobile: allow horizontal scroll for table if needed, but we now use cards in mobile */
      @media (max-width: 768px) {
        .table-wrapper { overflow-x: hidden; }
        .table-min { min-width: 0; }
      }
    </style>
  </head>

  <body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-6 md:py-8 max-w-7xl">
      <!-- Header -->
      <div class="bg-white rounded-lg shadow-lg p-5 md:p-6 mb-6 md:mb-8">
        <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-3 md:gap-4">
          <div>
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900">1898 Leather</h1>
            <h2 class="text-lg md:text-xl text-gray-600">Task Management System</h2>
            <p id="lastUpdated" class="text-gray-500 mt-2 text-sm md:text-base"></p>
            <p id="dataSourceLabel" class="text-xs text-gray-400 mt-1"></p>
          </div>

          <div class="md:text-right flex md:block items-center justify-between md:justify-end gap-3">
            <div>
              <div id="totalTasks" class="text-2xl md:text-2xl font-bold text-blue-600">0</div>
              <div class="text-sm text-gray-500">Total Tasks</div>
            </div>
            <button
              id="addTaskBtnTop"
              class="md:hidden px-4 py-3 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition"
            >
              + Add
            </button>
          </div>
        </div>
      </div>

      <!-- Controls -->
      <div class="bg-white rounded-lg shadow p-5 md:p-6 mb-6 md:mb-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
          <div>
            <label class="block text-xs uppercase tracking-widest text-gray-500" for="searchInput">Search</label>
            <input
              id="searchInput"
              type="search"
              placeholder="Search by task name or notes"
              class="mt-2 w-full rounded border border-gray-200 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200"
            />
          </div>

          <div>
            <label class="block text-xs uppercase tracking-widest text-gray-500" for="statusFilter">Status</label>
            <select
              id="statusFilter"
              class="mt-2 w-full rounded border border-gray-200 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200"
            >
              <option value="all">All Status</option>
              <option value="pending">Pending</option>
              <option value="planning">Planning</option>
              <option value="in-progress">In Progress</option>
              <option value="completed">Completed</option>
            </select>
          </div>

          <div class="flex items-end justify-between gap-3">
            <div class="flex-1">
              <label class="block text-xs uppercase tracking-widest text-gray-500">View</label>
              <div class="mt-2 flex flex-wrap gap-2">
                <button data-tab="all" class="tab tab-active px-4 py-2 rounded border border-gray-200 text-sm">All</button>
                <button data-tab="do" class="tab px-4 py-2 rounded border border-gray-200 text-sm">Do</button>
                <button data-tab="schedule" class="tab px-4 py-2 rounded border border-gray-200 text-sm">Schedule</button>
                <button data-tab="delegate" class="tab px-4 py-2 rounded border border-gray-200 text-sm">Delegate</button>
              </div>
            </div>

            <!-- Add Task Button (desktop) -->
            <div class="hidden md:flex justify-end">
              <button
                id="addTaskBtn"
                class="px-4 py-3 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition"
              >
                + Add Task
              </button>
            </div>
          </div>
        </div>

        <div class="mt-4 text-xs text-gray-400">
          Data is stored in Supabase • Changes sync across devices.
        </div>
      </div>

      <!-- Stats -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mb-6 md:mb-8">
        <div class="bg-white rounded-lg shadow p-5 md:p-6">
          <div id="activeTasks" class="text-2xl font-bold text-blue-600">0</div>
          <div class="text-sm text-gray-500">Active</div>
        </div>
        <div class="bg-white rounded-lg shadow p-5 md:p-6">
          <div id="completedTasks" class="text-2xl font-bold text-green-600">0</div>
          <div class="text-sm text-gray-500">Completed</div>
        </div>
        <div class="bg-white rounded-lg shadow p-5 md:p-6">
          <div id="inProgressTasks" class="text-2xl font-bold text-yellow-600">0</div>
          <div class="text-sm text-gray-500">In Progress</div>
        </div>
        <div class="bg-white rounded-lg shadow p-5 md:p-6">
          <div id="highPriorityTasks" class="text-2xl font-bold text-red-600">0</div>
          <div class="text-sm text-gray-500">High Priority</div>
        </div>
      </div>

      <!-- Task List -->
      <div class="bg-white rounded-lg shadow mb-8 overflow-hidden table-wrapper">
        <div class="px-5 md:px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">Tasks (Supabase)</h3>
          <p class="text-xs text-gray-500 mt-1">Desktop: sortable table • Mobile: cards.</p>
        </div>

        <!-- Header Row (desktop only) -->
        <div class="hidden md:grid header-row px-6 py-3 grid-cols-7 gap-4 text-sm text-gray-700 items-center">
          <div><span class="sort-btn" data-sort="id">ID <span class="sort-caret">↕</span></span></div>
          <div><span class="sort-btn" data-sort="name">Task Name <span class="sort-caret">↕</span></span></div>
          <div>Notes</div>
          <div><span class="sort-btn" data-sort="status">Status <span class="sort-caret">↕</span></span></div>
          <div><span class="sort-btn" data-sort="bucket">Eisenhower <span class="sort-caret">↕</span></span></div>
          <div><span class="sort-btn" data-sort="priority">Priority <span class="sort-caret">↕</span></span></div>
          <div class="text-right"><span class="sort-btn" data-sort="lastTouched">Actions / Date <span class="sort-caret">↕</span></span></div>
        </div>

        <!-- Rows -->
        <div id="taskRows" class="divide-y divide-gray-200"></div>
      </div>

      <div class="mt-8 text-center text-gray-500 text-sm">
        <p id="footerUpdated"></p>
        <p class="mt-1 text-xs text-gray-400">Note: This version stores tasks in Supabase (cloud).</p>
      </div>
    </div>

    <!-- Add Task Modal -->
    <div id="modalOverlay" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-60 modal-backdrop p-4">
      <div class="bg-white rounded-2xl shadow-2xl max-w-xl w-full overflow-hidden">
        <div class="p-6 border-b border-gray-100 flex items-center justify-between">
          <div>
            <h3 class="text-lg font-bold text-gray-900">Add New Task</h3>
            <p class="text-xs text-gray-500 mt-1">
              Tip: leave ID empty to auto-generate <span class="font-mono">T-1234</span>
            </p>
          </div>
          <button id="closeModalBtn" class="w-9 h-9 rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 font-bold" title="Close">✕</button>
        </div>

        <div class="p-6 space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-xs uppercase tracking-widest text-gray-500">ID</label>
              <input id="newTaskId" type="text" placeholder="e.g. DO-015, SCH-020, TASK-010"
                class="mt-2 w-full rounded border border-gray-200 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200" />
            </div>

            <div>
              <label class="block text-xs uppercase tracking-widest text-gray-500">Priority</label>
              <select id="newTaskPriority"
                class="mt-2 w-full rounded border border-gray-200 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200">
                <option value="High">High</option>
                <option value="Medium" selected>Medium</option>
                <option value="Low">Low</option>
              </select>
            </div>
          </div>

          <div>
            <label class="block text-xs uppercase tracking-widest text-gray-500">Task Name</label>
            <input id="newTaskName" type="text" placeholder="Task title..."
              class="mt-2 w-full rounded border border-gray-200 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200" />
          </div>

          <div>
            <label class="block text-xs uppercase tracking-widest text-gray-500">Notes</label>
            <textarea id="newTaskNotes" placeholder="Relevant notes, deliverables, owner, deadline..."
              class="mt-2 w-full rounded border border-gray-200 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200 h-28"></textarea>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-xs uppercase tracking-widest text-gray-500">Status</label>
              <select id="newTaskStatus"
                class="mt-2 w-full rounded border border-gray-200 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200">
                <option value="pending" selected>Pending</option>
                <option value="planning">Planning</option>
                <option value="in-progress">In Progress</option>
                <option value="completed">Completed</option>
              </select>
            </div>

            <div>
              <label class="block text-xs uppercase tracking-widest text-gray-500">Eisenhower</label>
              <select id="newTaskBucket"
                class="mt-2 w-full rounded border border-gray-200 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200">
                <option value="do" selected>DO</option>
                <option value="schedule">SCHEDULE</option>
                <option value="delegate">DELEGATE</option>
              </select>
            </div>
          </div>

          <div id="modalError" class="hidden text-sm text-red-600 font-semibold"></div>

          <div class="flex gap-3 pt-2">
            <button id="cancelModalBtn"
              class="flex-1 px-4 py-3 border rounded-lg text-sm font-bold text-gray-600 hover:bg-gray-50">
              Cancel
            </button>
            <button id="saveTaskBtn"
              class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg text-sm font-bold hover:bg-blue-700">
              Save Task
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Task Modal -->
    <div id="editOverlay" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-60 modal-backdrop p-4">
      <div class="bg-white rounded-2xl shadow-2xl max-w-xl w-full overflow-hidden">
        <div class="p-6 border-b border-gray-100 flex items-center justify-between">
          <div>
            <h3 class="text-lg font-bold text-gray-900">Edit Task</h3>
            <p class="text-xs text-gray-500 mt-1">
              Edit only <span class="font-semibold">Task Name</span> and <span class="font-semibold">Notes</span>.
            </p>
          </div>
          <button id="closeEditBtn" class="w-9 h-9 rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 font-bold" title="Close">✕</button>
        </div>

        <div class="p-6 space-y-4">
          <div class="text-xs text-gray-500 font-mono">
            ID: <span id="editTaskIdLabel" class="text-gray-800 font-bold"></span>
          </div>

          <div>
            <label class="block text-xs uppercase tracking-widest text-gray-500">Task Name</label>
            <input id="editTaskName" type="text" placeholder="Task title..."
              class="mt-2 w-full rounded border border-gray-200 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200" />
          </div>

          <div>
            <label class="block text-xs uppercase tracking-widest text-gray-500">Notes</label>
            <textarea id="editTaskNotes" placeholder="Relevant notes..."
              class="mt-2 w-full rounded border border-gray-200 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200 h-32"></textarea>
          </div>

          <div id="editError" class="hidden text-sm text-red-600 font-semibold"></div>

          <div class="flex gap-3 pt-2">
            <button id="cancelEditBtn"
              class="flex-1 px-4 py-3 border rounded-lg text-sm font-bold text-gray-600 hover:bg-gray-50">
              Cancel
            </button>
            <button id="saveEditBtn"
              class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg text-sm font-bold hover:bg-blue-700">
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // =========================
      // ✅ SUPABASE CONFIG (blinded against double execution)
      // =========================
      const SUPABASE_URL = "https://oyfmmpvpcqreivtkukjv.supabase.co";
      const SUPABASE_PUBLISHABLE_KEY = "sb_publishable_tIbfNdJr59KSj7jEIaOaAQ_2cT-z8iA";

      const supabaseClient =
        window.__supabaseClient__ ||
        (window.__supabaseClient__ = window.supabase.createClient(
          SUPABASE_URL,
          SUPABASE_PUBLISHABLE_KEY
        ));

      // =========================
      // ✅ APP STATE
      // =========================
      let tasks = [];

      // ====== UI HELPERS ======
      const priorityClass = (p) => (p === "High" ? "priority-high" : p === "Medium" ? "priority-medium" : "priority-low");

      const statusSelectClass = (s) => {
        if (s === "in-progress") return "sel-inprogress";
        if (s === "pending") return "sel-pending";
        if (s === "planning") return "sel-planning";
        if (s === "completed") return "sel-completed";
        return "sel-pending";
      };

      const bucketSelectClass = (b) => {
        if (b === "do") return "sel-do";
        if (b === "schedule") return "sel-schedule";
        if (b === "delegate") return "sel-delegate";
        return "sel-schedule";
      };

      const prioritySelectClass = (p) => (p === "High" ? "sel-High" : p === "Medium" ? "sel-Medium" : "sel-Low");

      // ====== SORTING ======
      let sortState = { key: "id", asc: true };
      const SORT_ORDER = {
        status: ["pending", "planning", "in-progress", "completed"],
        priority: ["High", "Medium", "Low"],
        bucket: ["do", "schedule", "delegate"],
      };

      function getRank(key, value) {
        const list = SORT_ORDER[key];
        if (!list) return null;
        const idx = list.indexOf(value);
        return idx === -1 ? 999 : idx;
      }
      function norm(v) { return v === null || v === undefined ? "" : String(v).trim(); }

      function sortBy(key) {
        if (sortState.key === key) sortState.asc = !sortState.asc;
        else { sortState.key = key; sortState.asc = true; }

        tasks.sort((a, b) => {
          const av = a?.[key];
          const bv = b?.[key];

          const ar = getRank(key, av);
          const br = getRank(key, bv);
          if (ar !== null && br !== null) return sortState.asc ? ar - br : br - ar;

          if (key === "lastTouched") {
            const ad = Date.parse(norm(av)) || 0;
            const bd = Date.parse(norm(bv)) || 0;
            return sortState.asc ? ad - bd : bd - ad;
          }

          if (key === "id") {
            const aStr = norm(av);
            const bStr = norm(bv);

            const aMatch = aStr.match(/^([A-Za-z-]+)?(\d+)?$/);
            const bMatch = bStr.match(/^([A-Za-z-]+)?(\d+)?$/);

            const aPrefix = (aMatch?.[1] || aStr).toLowerCase();
            const bPrefix = (bMatch?.[1] || bStr).toLowerCase();
            if (aPrefix !== bPrefix) return sortState.asc ? aPrefix.localeCompare(bPrefix) : bPrefix.localeCompare(aPrefix);

            const aNum = parseInt(aMatch?.[2] || "0", 10);
            const bNum = parseInt(bMatch?.[2] || "0", 10);
            return sortState.asc ? aNum - bNum : bNum - aNum;
          }

          const aStr = norm(av).toLowerCase();
          const bStr = norm(bv).toLowerCase();
          return sortState.asc ? aStr.localeCompare(bStr) : bStr.localeCompare(aStr);
        });

        updateSortUI();
        render();
      }

      function updateSortUI() {
        document.querySelectorAll(".sort-btn").forEach((el) => {
          const k = el.getAttribute("data-sort");
          el.classList.toggle("sort-active", k === sortState.key);
          const caret = el.querySelector(".sort-caret");
          if (!caret) return;
          caret.textContent = k === sortState.key ? (sortState.asc ? "↑" : "↓") : "↕";
        });
      }

      // ====== STATE / FILTERS ======
      let activeTab = "all";
      const els = {
        rows: document.getElementById("taskRows"),
        search: document.getElementById("searchInput"),
        status: document.getElementById("statusFilter"),
        tabs: Array.from(document.querySelectorAll(".tab")),
        total: document.getElementById("totalTasks"),
        active: document.getElementById("activeTasks"),
        completed: document.getElementById("completedTasks"),
        inprog: document.getElementById("inProgressTasks"),
        high: document.getElementById("highPriorityTasks"),
        lastUpdated: document.getElementById("lastUpdated"),
        footerUpdated: document.getElementById("footerUpdated"),
        dataSourceLabel: document.getElementById("dataSourceLabel"),
      };

      const setUpdatedText = () => {
        const now = new Date();
        const pretty = now.toLocaleString(undefined, {
          year: "numeric",
          month: "short",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
        });
        els.lastUpdated.textContent = `Last updated: ${pretty}`;
        els.footerUpdated.textContent = `1898 Leather Task Management System • Last updated: ${pretty}`;
      };

      const computeStats = (items) => {
        els.total.textContent = items.length;
        els.completed.textContent = items.filter((t) => t.status === "completed").length;
        els.inprog.textContent = items.filter((t) => t.status === "in-progress").length;
        els.active.textContent = items.filter((t) => t.status !== "completed").length;
        els.high.textContent = items.filter((t) => t.priority === "High").length;
      };

      const matchFilters = (t) => {
        const q = (els.search.value || "").toLowerCase().trim();
        const st = els.status.value;

        const tabMatch = activeTab === "all" ? true : t.bucket === activeTab;
        const statusMatch = st === "all" ? true : t.status === st;

        const text = `${t.id} ${t.name} ${t.notes} ${t.priority} ${t.lastTouched} ${t.bucket}`.toLowerCase();
        const queryMatch = !q ? true : text.includes(q);

        return tabMatch && statusMatch && queryMatch;
      };

      // =========================
      // ✅ SUPABASE MAPPERS
      // =========================
      function sanitizeTask(t) {
        return {
          id: t.id || `T-${Math.floor(Math.random() * 9000) + 1000}`,
          name: t.name || "",
          notes: t.notes || "",
          status: t.status || "pending",
          lastTouched: t.lastTouched || new Date().toISOString().split("T")[0],
          priority: t.priority || "Medium",
          bucket: t.bucket || "schedule",
        };
      }

      function rowToTask(r) {
        return sanitizeTask({
          id: r.id,
          name: r.name,
          notes: r.notes,
          status: r.status,
          bucket: r.bucket,
          priority: r.priority,
          lastTouched: r.last_touched,
        });
      }

      function taskToRow(t) {
        return {
          id: t.id,
          name: t.name,
          notes: t.notes || "",
          status: t.status,
          bucket: t.bucket,
          priority: t.priority,
          last_touched: t.lastTouched || new Date().toISOString().split("T")[0],
        };
      }

      // =========================
      // ✅ SUPABASE CRUD
      // =========================
      async function loadTasks() {
        try {
          els.dataSourceLabel.textContent = "Data source: Supabase";

          const { data, error } = await supabaseClient
            .from("tasks")
            .select("*")
            .order("created_at", { ascending: false });

          if (error) throw error;

          tasks = (data || []).map(rowToTask);
          updateSortUI();
          render();
        } catch (e) {
          console.error("SUPABASE LOAD ERROR:", e);
          els.dataSourceLabel.textContent = "Data source: ERROR (check console, RLS policies, table name)";
          els.rows.innerHTML = `
            <div class="px-6 py-8 text-center text-sm text-red-600 font-semibold">
              Could not load tasks from Supabase. Open DevTools console for details.
            </div>
          `;
        }
      }

      async function upsertTask(t) {
        const row = taskToRow(t);
        const { error } = await supabaseClient.from("tasks").upsert(row);
        if (error) throw error;
      }

      async function updateTaskInSupabase(id, fields) {
        const payload = { ...fields };
        if ("lastTouched" in payload) {
          payload.last_touched = payload.lastTouched;
          delete payload.lastTouched;
        }
        const { error } = await supabaseClient.from("tasks").update(payload).eq("id", id);
        if (error) throw error;
      }

      async function deleteTaskInSupabase(id) {
        const { error } = await supabaseClient.from("tasks").delete().eq("id", id);
        if (error) throw error;
      }

      // ====== ACTIONS ======
      async function updateTask(id, fields) {
        const idx = tasks.findIndex((x) => x.id === id);
        if (idx === -1) return;

        tasks[idx] = {
          ...tasks[idx],
          ...fields,
          lastTouched: new Date().toISOString().split("T")[0],
        };
        render();

        try {
          await updateTaskInSupabase(id, {
            ...fields,
            lastTouched: tasks[idx].lastTouched,
          });
        } catch (e) {
          console.error("SUPABASE UPDATE ERROR:", e);
          alert("No se pudo guardar en Supabase. Revisa consola.");
          loadTasks();
        }
      }

      async function deleteTask(id) {
        if (!confirm("Delete this task?")) return;

        tasks = tasks.filter((t) => t.id !== id);
        render();

        try {
          await deleteTaskInSupabase(id);
        } catch (e) {
          console.error("SUPABASE DELETE ERROR:", e);
          alert("No se pudo borrar en Supabase. Revisa consola.");
          loadTasks();
        }
      }

      window.updateTask = updateTask;
      window.deleteTask = deleteTask;

      // ====== EDIT MODAL ======
      const editOverlay = document.getElementById("editOverlay");
      const editError = document.getElementById("editError");
      let editingId = null;

      function showEditError(msg) { editError.textContent = msg; editError.classList.remove("hidden"); }
      function clearEditError() { editError.textContent = ""; editError.classList.add("hidden"); }

      function openEdit(id) {
        const t = tasks.find((x) => x.id === id);
        if (!t) return;

        editingId = id;
        clearEditError();

        document.getElementById("editTaskIdLabel").textContent = t.id;
        document.getElementById("editTaskName").value = t.name || "";
        document.getElementById("editTaskNotes").value = t.notes || "";

        editOverlay.classList.remove("hidden");
        editOverlay.classList.add("flex");
        setTimeout(() => document.getElementById("editTaskName").focus(), 50);
      }

      function closeEdit() {
        editOverlay.classList.add("hidden");
        editOverlay.classList.remove("flex");
        editingId = null;
      }

      async function saveEdit() {
        if (!editingId) return;
        const name = (document.getElementById("editTaskName").value || "").trim();
        const notes = (document.getElementById("editTaskNotes").value || "").trim();
        if (!name) return showEditError("Task Name can't be empty.");

        await updateTask(editingId, { name, notes });
        closeEdit();
      }

      window.openEdit = openEdit;

      // ====== ADD TASK MODAL ======
      const modal = document.getElementById("modalOverlay");
      const modalError = document.getElementById("modalError");

      function showModalError(msg) { modalError.textContent = msg; modalError.classList.remove("hidden"); }
      function clearModalError() { modalError.textContent = ""; modalError.classList.add("hidden"); }

      function openModal() {
        clearModalError();
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        setTimeout(() => document.getElementById("newTaskName").focus(), 50);
      }

      function closeModal() {
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      }

      function normalizeId(raw) { return String(raw || "").trim(); }
      function generateId() { return `T-${Math.floor(Math.random() * 9000) + 1000}`; }
      function idExists(id) { return tasks.some((t) => t.id === id); }

      async function submitNewTask() {
        clearModalError();

        let id = normalizeId(document.getElementById("newTaskId").value);
        const name = (document.getElementById("newTaskName").value || "").trim();
        const notes = (document.getElementById("newTaskNotes").value || "").trim();
        const status = document.getElementById("newTaskStatus").value;
        const bucket = document.getElementById("newTaskBucket").value;
        const priority = document.getElementById("newTaskPriority").value;

        if (!name) return showModalError("Task Name is required.");
        if (!id) id = generateId();

        if (!/^[A-Za-z]+(?:-[A-Za-z]+)?-\d+$/.test(id) && !/^T-\d+$/.test(id)) {
          return showModalError("Invalid ID format. Use DO-001, SCH-010, TASK-004 or leave blank for auto ID.");
        }
        if (idExists(id)) return showModalError("That ID already exists. Use another ID.");

        const newTask = sanitizeTask({
          id, name, notes, status, priority, bucket,
          lastTouched: new Date().toISOString().split("T")[0],
        });

        tasks.unshift(newTask);
        render();

        try {
          await upsertTask(newTask);
        } catch (e) {
          console.error("SUPABASE INSERT ERROR:", e);
          alert("No se pudo crear en Supabase. Revisa consola (RLS/tabla).");
          loadTasks();
          return;
        }

        document.getElementById("newTaskId").value = "";
        document.getElementById("newTaskName").value = "";
        document.getElementById("newTaskNotes").value = "";
        document.getElementById("newTaskStatus").value = "pending";
        document.getElementById("newTaskBucket").value = "do";
        document.getElementById("newTaskPriority").value = "Medium";

        closeModal();
      }

      modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });
      editOverlay.addEventListener("click", (e) => { if (e.target === editOverlay) closeEdit(); });

      document.addEventListener("keydown", (e) => {
        if (e.key !== "Escape") return;
        if (!modal.classList.contains("hidden")) closeModal();
        if (!editOverlay.classList.contains("hidden")) closeEdit();
      });

      // ====== RENDER (desktop table + mobile cards)
      function render() {
        setUpdatedText();

        const filtered = tasks.filter(matchFilters);
        computeStats(filtered);

        if (!filtered.length) {
          els.rows.innerHTML = `
            <div class="px-6 py-8 text-center text-sm text-gray-500">
              No tasks match your filters.
            </div>
          `;
          return;
        }

        els.rows.innerHTML = filtered.map((t) => `
          <!-- MOBILE CARD -->
          <div class="md:hidden p-4 ${priorityClass(t.priority)}">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="text-xs text-gray-500 font-mono">${escapeHtml(t.id)}</div>
                <div class="font-semibold text-gray-900 mt-1 wrap-anywhere">${escapeHtml(t.name)}</div>
              </div>
              <div class="text-xs text-gray-500 whitespace-nowrap">${escapeHtml(t.lastTouched || "")}</div>
            </div>

            <div class="mt-3 text-sm text-gray-600 wrap-anywhere clamp-3">${escapeHtml(t.notes || "")}</div>

            <div class="mt-4 grid grid-cols-3 gap-2">
              <div>
                <div class="text-[10px] uppercase tracking-widest text-gray-400 mb-1">Status</div>
                <select class="pill-select ${statusSelectClass(t.status)}"
                  onchange="updateTask('${escapeAttr(t.id)}', { status: this.value })">
                  <option value="pending" ${t.status === "pending" ? "selected" : ""}>Pending</option>
                  <option value="planning" ${t.status === "planning" ? "selected" : ""}>Planning</option>
                  <option value="in-progress" ${t.status === "in-progress" ? "selected" : ""}>In Progress</option>
                  <option value="completed" ${t.status === "completed" ? "selected" : ""}>Completed</option>
                </select>
              </div>

              <div>
                <div class="text-[10px] uppercase tracking-widest text-gray-400 mb-1">Bucket</div>
                <select class="pill-select ${bucketSelectClass(t.bucket)}"
                  onchange="updateTask('${escapeAttr(t.id)}', { bucket: this.value })">
                  <option value="do" ${t.bucket === "do" ? "selected" : ""}>DO</option>
                  <option value="schedule" ${t.bucket === "schedule" ? "selected" : ""}>SCHEDULE</option>
                  <option value="delegate" ${t.bucket === "delegate" ? "selected" : ""}>DELEGATE</option>
                </select>
              </div>

              <div>
                <div class="text-[10px] uppercase tracking-widest text-gray-400 mb-1">Priority</div>
                <select class="pill-select ${prioritySelectClass(t.priority)}"
                  onchange="updateTask('${escapeAttr(t.id)}', { priority: this.value })">
                  <option value="High" ${t.priority === "High" ? "selected" : ""}>HIGH</option>
                  <option value="Medium" ${t.priority === "Medium" ? "selected" : ""}>MEDIUM</option>
                  <option value="Low" ${t.priority === "Low" ? "selected" : ""}>LOW</option>
                </select>
              </div>
            </div>

            <div class="mt-4 flex gap-2">
              <button class="flex-1 px-3 py-2 rounded bg-blue-600 text-white text-xs font-semibold hover:bg-blue-700"
                onclick="openEdit('${escapeAttr(t.id)}')">Edit</button>
              <button class="flex-1 px-3 py-2 rounded bg-red-600 text-white text-xs font-semibold hover:bg-red-700"
                onclick="deleteTask('${escapeAttr(t.id)}')">Delete</button>
            </div>
          </div>

          <!-- DESKTOP ROW -->
          <div class="hidden md:grid task-row px-6 py-4 grid-cols-7 gap-4 items-start ${priorityClass(t.priority)}">
            <div class="font-mono text-sm text-gray-600">${escapeHtml(t.id)}</div>
            <div class="font-semibold text-gray-900 wrap-anywhere">${escapeHtml(t.name)}</div>
            <div class="text-gray-600 text-sm wrap-anywhere clamp-3">${escapeHtml(t.notes || "")}</div>

            <div>
              <select class="pill-select ${statusSelectClass(t.status)}"
                onchange="updateTask('${escapeAttr(t.id)}', { status: this.value })">
                <option value="pending" ${t.status === "pending" ? "selected" : ""}>Pending</option>
                <option value="planning" ${t.status === "planning" ? "selected" : ""}>Planning</option>
                <option value="in-progress" ${t.status === "in-progress" ? "selected" : ""}>In Progress</option>
                <option value="completed" ${t.status === "completed" ? "selected" : ""}>Completed</option>
              </select>
            </div>

            <div>
              <select class="pill-select ${bucketSelectClass(t.bucket)}"
                onchange="updateTask('${escapeAttr(t.id)}', { bucket: this.value })">
                <option value="do" ${t.bucket === "do" ? "selected" : ""}>DO</option>
                <option value="schedule" ${t.bucket === "schedule" ? "selected" : ""}>SCHEDULE</option>
                <option value="delegate" ${t.bucket === "delegate" ? "selected" : ""}>DELEGATE</option>
              </select>
            </div>

            <div>
              <select class="pill-select ${prioritySelectClass(t.priority)}"
                onchange="updateTask('${escapeAttr(t.id)}', { priority: this.value })">
                <option value="High" ${t.priority === "High" ? "selected" : ""}>HIGH</option>
                <option value="Medium" ${t.priority === "Medium" ? "selected" : ""}>MEDIUM</option>
                <option value="Low" ${t.priority === "Low" ? "selected" : ""}>LOW</option>
              </select>
            </div>

            <div class="flex flex-col items-end gap-2">
              <div class="text-sm text-gray-500">${escapeHtml(t.lastTouched || "")}</div>
              <div class="flex items-center gap-2">
                <button class="px-3 py-1 rounded bg-blue-600 text-white text-xs font-semibold hover:bg-blue-700"
                  onclick="openEdit('${escapeAttr(t.id)}')" title="Edit">Edit</button>
                <button class="px-3 py-1 rounded bg-red-600 text-white text-xs font-semibold hover:bg-red-700"
                  onclick="deleteTask('${escapeAttr(t.id)}')" title="Delete">Delete</button>
              </div>
            </div>
          </div>
        `).join("");
      }

      function escapeHtml(str) {
        return String(str).replace(/[&<>"']/g, (s) => ({
          "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;",
        }[s]));
      }
      function escapeAttr(str) { return String(str).replace(/'/g, "\\'"); }

      // ====== EVENTS ======
      els.search.addEventListener("input", render);
      els.status.addEventListener("change", render);

      els.tabs.forEach((btn) => {
        btn.addEventListener("click", () => {
          activeTab = btn.getAttribute("data-tab");
          els.tabs.forEach((b) => b.classList.remove("tab-active"));
          btn.classList.add("tab-active");
          render();
        });
      });

      document.querySelectorAll(".sort-btn").forEach((btn) => {
        btn.addEventListener("click", () => sortBy(btn.getAttribute("data-sort")));
      });

      // open modal from both buttons
      document.getElementById("addTaskBtn").addEventListener("click", openModal);
      document.getElementById("addTaskBtnTop").addEventListener("click", openModal);

      document.getElementById("closeModalBtn").addEventListener("click", closeModal);
      document.getElementById("cancelModalBtn").addEventListener("click", closeModal);
      document.getElementById("saveTaskBtn").addEventListener("click", submitNewTask);

      document.getElementById("closeEditBtn").addEventListener("click", closeEdit);
      document.getElementById("cancelEditBtn").addEventListener("click", closeEdit);
      document.getElementById("saveEditBtn").addEventListener("click", saveEdit);

      // ====== REALTIME SYNC (subscribe once)
      if (!window.__tasksRealtimeSubscribed__) {
        window.__tasksRealtimeSubscribed__ = true;
        supabaseClient
          .channel("tasks-realtime")
          .on("postgres_changes", { event: "*", schema: "public", table: "tasks" }, () => loadTasks())
          .subscribe();
      }

      // ====== INIT
      updateSortUI();
      loadTasks();
    </script>
  </body>
</html>
